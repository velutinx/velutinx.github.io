<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>VELUTINX â€” Poll</title>
  <link rel="stylesheet" href="/assets/css/styles.css">
  <style>
    /* Poll-specific styles */
    .poll-section {
      max-width: 1600px;
      margin: 0 auto;
      padding: 40px 24px;
      position: relative;
    }

    .poll-title {
      text-align: center;
      font-size: 28px;
      letter-spacing: 2px;
      margin-bottom: 8px;
    }

    .poll-subtitle {
      text-align: center;
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 40px;
    }

    .poll-page {
      position: relative;
    }

    /* Big cards */
    .big-card {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 500px;
      height: 800px;
      border-radius: 24px;
      overflow: hidden;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 10;
    }

    .big-card.show {
      opacity: 1;
    }

    .big-card img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      loading: lazy;
    }

    #leftBig { left: -600px; }
    #rightBig { right: -600px; }

    /* Grid */
    .grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .card {
      background: rgba(245,241,223,0.97);
      border-radius: 12px;
      padding: 8px;
      cursor: pointer;
      position: relative;
      transition: transform 0.2s ease;
    }

    .card:hover {
      transform: scale(1.05);
      animation: blobWobble 1.6s ease-in-out infinite;
    }

    .card img {
      width: 100%;
      border-radius: 8px;
      loading: lazy;
    }

    .progress {
      position: absolute;
      left: 8px;
      right: 8px;
      bottom: 26px;
      height: 14px;
      border-radius: 7px;
      background: rgba(0,0,0,0.15);
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg,#5a8cff,#8fb6ff);
      transition: width 0.4s ease;
    }

    .progress-text {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 11px;
      color: white;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }

    .label {
      margin-top: 6px;
      text-align: center;
      font-size: 13px;
      font-weight: bold;
    }

    /* Bottom */
    .bottom {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 40px;
      margin-top: 60px;
    }

    #leaderboard {
      background: rgba(255,255,255,0.9);
      padding: 12px 16px;
      border-radius: 10px;
      min-width: 260px;
      text-align: center;
    }

    #leaderboard h3 {
      margin: 0 0 8px;
      font-size: 16px;
    }

    .tooltip {
      font-size: 11px;
      opacity: 0.7;
      margin-bottom: 8px;
    }

    .leaderboard-entry {
      font-size: 13px;
      padding: 2px 0;
    }

    .icon-link img {
      width: 180px;
      transition: transform 0.25s ease;
    }

    .icon-link img:hover {
      animation: blobWobble 1.6s ease-in-out infinite;
    }

    .discord-disclaimer {
      margin-top: 8px;
      font-size: 13px;
      opacity: 0.9;
    }

    @media (max-width: 1200px) {
      .big-card { display: none; }
      .grid { grid-template-columns: repeat(4, 1fr); }
    }

    @media (max-width: 800px) {
      .grid { grid-template-columns: repeat(3, 1fr); }
      .bottom { flex-direction: column; align-items: center; gap: 20px; }
    }
  </style>
</head>
<body>

  <!-- Fixed controls -->
  <div class="lang-swipe" id="langSwipe"></div>
  <div class="lang-toggle" id="langToggle">ðŸ‡¯ðŸ‡µ</div>
  <div class="theme-toggle" id="themeToggle">
    <div class="theme-knob"></div>
  </div>

  <!-- Page wrapper -->
  <div id="page">

    <!-- Navigation -->
    <div id="navContainer"></div>

    <div class="divider"></div>

    <!-- Poll section -->
    <section class="poll-section">
      <h1 class="poll-title">Vote for Your Favorite Character</h1>
      <p class="poll-subtitle">Click once â€” you can change your vote anytime</p>

      <div class="poll-page">
        <!-- Big cards -->
        <div class="big-card" id="leftBig">
          <img id="leftImg" src="/images/poll/1.jpg" loading="lazy">
        </div>
        <div class="big-card" id="rightBig">
          <img id="rightImg" src="/images/poll/1.jpg" loading="lazy">
        </div>

        <!-- Center content -->
        <div class="center">
          <div class="grid" id="grid"></div>

          <div class="bottom">
            <div class="icon-wrapper">
              <a class="icon-link" href="/" target="_blank">
                <img src="/images/LogoWebsite.png" alt="Website">
              </a>
            </div>

            <div id="leaderboard">
              <h3>Leaderboard</h3>
              <div class="tooltip">Website votes only</div>
              <div id="results">Loadingâ€¦</div>
            </div>

            <div class="icon-wrapper">
              <a class="icon-link" href="https://discord.gg/6sHSVMEE" target="_blank">
                <img src="/images/LogoDiscord.png" alt="Discord">
              </a>
              <div class="discord-disclaimer">Join discord for an extra vote!!</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div class="divider"></div>

  </div>

  <!-- Shared navigation loader -->
  <script src="/assets/js/navigation.js"></script>

  <!-- Poll logic -->
  <script>
    // ---------- Persistence & language/theme ----------
    const savedLang = localStorage.getItem("language");
    const savedDark = localStorage.getItem("darkMode") === "true";

    let isJapanese = savedLang === "jp";

    function translateBlobs(isJp) {
      const blobs = document.querySelectorAll(".blob-text");
      if (blobs.length === 0) {
        setTimeout(() => translateBlobs(isJp), 100);
        return;
      }
      blobs.forEach(t => {
        t.textContent = isJp ? t.dataset.jp : t.dataset.en;
      });
    }

    translateBlobs(isJapanese);
    document.getElementById("langToggle").textContent = isJapanese ? "ðŸ‡ºðŸ‡¸" : "ðŸ‡¯ðŸ‡µ";

    if (savedDark) {
      document.body.classList.add("dark");
    }

    langToggle.onclick = () => {
      langSwipe.classList.remove("active");
      void langSwipe.offsetWidth;
      langSwipe.classList.add("active");

      setTimeout(() => {
        isJapanese = !isJapanese;
        translateBlobs(isJapanese);
        langToggle.textContent = isJapanese ? "ðŸ‡ºðŸ‡¸" : "ðŸ‡¯ðŸ‡µ";
        localStorage.setItem("language", isJapanese ? "jp" : "en");
      }, 180);
    };

    themeToggle.onclick = () => {
      document.body.classList.toggle("dark");
      localStorage.setItem("darkMode", document.body.classList.contains("dark"));
    };

    // Cursor sparkles
    let lastStarTime = 0;
    document.addEventListener("mousemove", (e) => {
      const now = Date.now();
      if (now - lastStarTime < 45) return;
      lastStarTime = now;

      const star = document.createElement("div");
      star.className = "star";
      star.textContent = "âœ¦";
      star.style.setProperty("--drift", Math.random());
      star.style.left = e.clientX + "px";
      star.style.top = e.clientY + "px";

      document.body.appendChild(star);
      setTimeout(() => star.remove(), 2000);
    });

    // Full-page falling sparkles
    setInterval(() => {
      const star = document.createElement("div");
      star.className = "falling-star";
      star.textContent = "âœ¦";
      star.style.left = Math.random() * 100 + "vw";
      star.style.top = "-10vh";
      star.style.setProperty("--drift", Math.random() * 2 - 1);
      document.body.appendChild(star);
      setTimeout(() => star.remove(), 8000);
    }, 400);

    // ---------- Poll logic ----------
    const SUPABASE_URL = "https://knbvlyngmjaxndkiqggl.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtuYnZseW5nbWpheG5ka2lxZ2dsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MjI0NzEsImV4cCI6MjA4NjM5ODQ3MX0.mxthCDB6dCaHcEDMFN48pFnaJmcBbilXfP7tL-YAV08";

    const POLL_ID = "character_poll_new";
    const TOTAL = 12;

    const grid = document.getElementById("grid");
    const resultsBox = document.getElementById("results");

    const leftImg = document.getElementById("leftImg");
    const leftBig = document.getElementById("leftBig");

    const rightImg = document.getElementById("rightImg");
    const rightBig = document.getElementById("rightBig");

    let rotateIndex = 1;

    // Per-browser voter hash
    let voterHash = localStorage.getItem("voter_hash_poll");
    if (!voterHash) {
      voterHash = crypto.randomUUID();
      localStorage.setItem("voter_hash_poll", voterHash);
    }
    console.log("Current voter hash (per-browser):", voterHash);

    // Build small cards
    for (let i = 1; i <= TOTAL; i++) {
      const card = document.createElement("div");
      card.className = "card";
      card.dataset.id = i;

      card.innerHTML = `
        <img src="/images/poll/${i}.jpg" loading="lazy">
        <div class="progress">
          <div class="progress-fill"></div>
          <div class="progress-text">0%</div>
        </div>
        <div class="label">Loadingâ€¦</div>
      `;

      card.onclick = async () => {
        showSelected(i);
        await vote(i);
      };

      grid.appendChild(card);
    }

    // Show selected on left big card
    function showSelected(id) {
      leftBig.classList.remove("show");
      setTimeout(() => {
        leftImg.src = `/images/poll/${id}.jpg`;
        leftBig.classList.add("show");
      }, 150);
    }

    // Rotate right big card
    function rotate() {
      rightBig.classList.remove("show");
      setTimeout(() => {
        rightImg.src = `/images/poll/${rotateIndex}.jpg`;
        rightBig.classList.add("show");
        rotateIndex = (rotateIndex % TOTAL) + 1;
      }, 150);
    }

    setInterval(rotate, 3500);
    rotate();
    showSelected(1);

    // Vote function â€” upsert with on_conflict (reliable, like your old working code)
    async function vote(optionId) {
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/votes?on_conflict=poll_id,voter_hash`, {
          method: "POST",
          headers: {
            apikey: SUPABASE_KEY,
            Authorization: `Bearer ${SUPABASE_KEY}`,
            "Content-Type": "application/json",
            Prefer: "resolution=merge-duplicates"
          },
          body: JSON.stringify({
            poll_id: POLL_ID,
            option_id: optionId,
            voter_hash: voterHash
          })
        });

        if (response.ok || response.status === 409) {
          console.log("Vote successful / updated");
          setTimeout(() => {
            fetchResults();
            fetchLeaderboard();
          }, 800);
        } else {
          const err = await response.text();
          console.error("Vote failed:", response.status, err);
          alert("Vote failed â€“ check console for details");
        }
      } catch (err) {
        console.error("Vote error:", err);
      }
    }

    // Progress bars â€“ direct from votes table (reliable)
    async function fetchResults() {
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/votes?poll_id=eq.${POLL_ID}&select=option_id`, {
          headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` }
        });

        if (!res.ok) throw new Error(await res.text());

        const votes = await res.json();
        console.log("Raw votes fetched:", votes.length, "votes");

        const counts = {};
        for (let i = 1; i <= TOTAL; i++) counts[i] = 0;
        votes.forEach(v => { if (v.option_id) counts[v.option_id]++; });

        const total = votes.length || 1;

        document.querySelectorAll(".card").forEach(card => {
          const id = Number(card.dataset.id);
          const percent = Math.round((counts[id] / total) * 100);
          card.querySelector(".progress-fill").style.width = percent + "%";
          card.querySelector(".progress-text").textContent = percent + "%";
        });
      } catch (err) {
        console.error("fetchResults error:", err);
      }
    }

    // Leaderboard + card labels â€“ from poll_result view
    async function fetchLeaderboard() {
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/poll_result?order=score.desc`, {
          headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` }
        });

        if (!res.ok) throw new Error(await res.text());

        const rows = await res.json();
        console.log("poll_result fetched:", rows.length, "rows", rows);

        let html = "";
        rows.forEach(r => {
          html += `<div class="leaderboard-entry">${r.character_name || `Option ${r.option_id}`}: ${Number(r.score || 0).toFixed(1)}</div>`;
        });
        resultsBox.innerHTML = html || "No votes yet";

        // Update card labels
        document.querySelectorAll(".card").forEach(card => {
          const id = Number(card.dataset.id);
          const row = rows.find(r => Number(r.option_id) === id);
          if (row?.character_name) {
            card.querySelector(".label").textContent = row.character_name;
          }
        });
      } catch (err) {
        console.error("fetchLeaderboard error:", err);
        resultsBox.innerHTML = "Error loading leaderboard";
      }
    }

    // Initial load
    fetchResults();
    fetchLeaderboard();
    setInterval(fetchResults, 30000);
    setInterval(fetchLeaderboard, 30000);

    // Organic wobble for cards
    document.querySelectorAll('.card, .big-card').forEach(el => {
      const offset = Math.random() * 1.5;
      el.style.setProperty('--random-offset', `${offset}s`);
    });
  </script>

  <!-- Shared tab title animation -->
  <script src="/assets/js/tab-title-animation.js"></script>

</body>
</html>
